// Test for stack argument marshalling with odd-sized structs.
// This test specifically checks that 9-byte structs passed as stack arguments
// (7th+ argument on x86_64) are correctly marshalled without buffer overruns.
//
// Before the fix, the code would copy remaining bytes in 4-byte chunks,
// which would read/write past the end of 9-byte arguments (8 bytes + 1 byte,
// but the remainder handler would copy 4 bytes instead of 1).

struct Test9Bytes {
  a: int64;
  b: int8;
}

extern func PirxTestStackArg9Bytes(
  arg1: int, arg2: int, arg3: int,
  arg4: int, arg5: int, arg6: int,
  s: Test9Bytes
): int;

func main(): int {
  var s: Test9Bytes;
  s.a = 0x123456789ABCDEF0l;
  s.b = 42i8;

  // Call with 6 register args + 1 stack arg (the 9-byte struct)
  var result = PirxTestStackArg9Bytes(1, 2, 3, 4, 5, 6, s);

  if (result == 1) {
    printf("PASS: 9-byte stack argument marshalled correctly\n");
    return 0;
  } else {
    printf("FAIL: 9-byte stack argument corrupted\n");
    return 1;
  }
}
